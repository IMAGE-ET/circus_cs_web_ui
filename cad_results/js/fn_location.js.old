function CreatePosStr()
{
	var tObj= document.getElementById("posTable");
	var registTime = jQuery("#registTime").val();
	
	rowNum = tObj.rows["length"]-1;
	var colNum = tObj.rows[0].cells["length"];
	var mode = jQuery("#feedbackMode").val();
	var posStr = "";
	
	var startCol = 2;
	var endCol   = 4;
	
	if(registTime != "")
	{
		startCol = 1;
		endCol   = 3;
	}
	
	for(var j=1; j<=rowNum; j++)
	{
		for(var i=startCol; i<=endCol; i++)
		{
			posStr += (tObj.rows[j].cells[i].innerHTML + '^');
		}
		
		var tmpStr = tObj.rows[j].cells[endCol+1].innerHTML.substr(0,6);
		
		//if(tmpStr == 'check')  posStr += 'BT^';
		if(tmpStr == 'check')  posStr += CheckNearestHiddenTP(j) + '^';
		else                   posStr += (tObj.rows[j].cells[endCol+1].innerHTML + '^');
	
		if(mode == "consensualFeedback")
		{
			posStr += (tObj.rows[j].cells[endCol+2].innerHTML.replace(' ','') + '^');
			posStr += (tObj.rows[j].cells[endCol+3].innerHTML.replace(' ','') + '^');
		}
		else
		{
			 posStr += (document.getElementById('userID').value + '^^');
		}
	}

	return posStr;
}

function ReturnCADResult(sessionID, sessionName)
{
	var address = 'show_cad_results.php'
                + '?execID=' + jQuery("#execID").val()
                + '&cadName=' + jQuery("#cadName").val()
                + '&version=' + jQuery("#version").val()
                + '&studyInstanceUID=' + jQuery("#studyInstanceUID").val()
                + '&seriesInstanceUID=' + jQuery("#seriesInstanceUID").val()
                + '&feedbackMode=' + jQuery("#feedbackMode").val()
                + '&' + sessionName + '=' + sessionID;

	self.location.replace(address);
}

function JumpImgNumber(imgNum)
{
	var posStr = CreatePosStr();

	var tObj= document.getElementById("posTable");
	var rowNum = tObj.rows["length"]-1;

	var address = 'false_negative_location.php'
                + '?execID=' + jQuery("#execID").val()
                + '&cadName=' + jQuery("#cadName").val()
                + '&version=' + jQuery("#version").val()
                + '&studyInstanceUID=' + jQuery("#studyInstanceUID").val()
                + '&seriesInstanceUID=' + jQuery("#seriesInstanceUID").val()
                + '&feedbackMode=' + jQuery("#feedbackMode").val()
				+ '&posStr=' + posStr
                + '&rowNum=' + rowNum
                + '&imgNum=' + imgNum
                + '&interruptFNFlg=' + jQuery("#interruptFNFlg").val()
                + '&registFNFlg=' + jQuery("#registFNFlg").val()
                + '&registTime=' + jQuery("#registTime").val()
                + '&visibleFlg=' + jQuery("#visibleFlg").val()
				+ '&grayscaleStr=' + jQuery("#grayscaleStr").val()
				+ '&presetName=' + jQuery("#presetName").val()
				+ '&windowLevel=' + jQuery("#windowLevel").val()
				+ '&windowWidth=' + jQuery("#windowWidth").val()
                + '&ticket=' + jQuery("#ticket").val();

	if(jQuery("#feedbackMode").val() == "consensualFeedback")
	{
		address += '&userStr=' + jQuery("#userStr").val();
	}

	self.location.replace(address);
}

function JumpImgNumBySliceLocation(origin, pitch, offset, fNum)
{
	var sliceLoc = jQuery("#sliceLoc").val();
	
	var imgNum = parseInt(((sliceLoc - origin) / pitch) + offset + 1.5);
	
	if(imgNum < (offset + 1))    imgNum = offset + 1;
	else if(imgNum > fNum)  imgNum = fNum;
	
	JumpImgNumber(imgNum);
}

function ClickPositionTable(id, imgNum)
{
	ChangeBgColor(id);

	if(!jQuery('#checkVisibleFN').attr('checked'))
	{
		jQuery('#checkVisibleFN').attr('checked', true);
		jQuery("#visibleFlg").val(1);
	}

	JumpImgNumber(imgNum);
}


function plotDots(id, x, y, set)
{
	var dotOffsetX = -1;
	var dotOffsetY = -1;
	var labelOffsetX = 0;
	var labelOffsetY = 0;

	var labelBaseX = 0;
	var labelBaseY = 0;
	var color = "#ff00ff";

	switch(set)
	{
		case 1:
			labelBaseX = 3;
			labelBaseY = -20;
			color = "#32cd32";
			break;
	
		case 2:
			labelBaseX = (id < 10) ? -11 : -20;
			labelBaseY = -20;
			color = "#ff8c00";
			break;
	
		case 3:
			labelBaseX = (id < 10) ? -11 : -20;
			color = "#ff0000";
			break;

		default: // case 0
			labelBaseX = 3;
			break;
	}

	// for IE
	if (document.all)
	{
		dotOffsetX = 2;
		labelOffsetX = 3;
		labelOffsetY = 1;
	}

	var htmlStr = '<span id="dot' + id + '" class="dot" style="top:' + (y+dotOffsetY) + 'px; left:' + (x+dotOffsetX) + 'px; '
        	    + 'height:3px; width:3px; padding:0px; background-color:' + color + ';"></span>'
				+ '<span id="label' + id + '" class="dot" style="top:' + (y+labelBaseY+labelOffsetY) + 'px;'
				+ ' left:' + (x+labelBaseX+labelOffsetX) + 'px; color:' + color + ';'
				+ ' filter:dropshadow(color=#000000 offX=1 offY=0) dropshadow(color=#000000 offX=-1 offY=0)'
				+ ' dropshadow(color=#000000 offX=0 offY=1) dropshadow(color=#000000 offX=0 offY=-1);'
				+ ' font-weight:bold;">' + id + '</span>';

	jQuery("#imgBlock").append(htmlStr);
}


function plotClickedLocation(id, x, y, set)
{
	// parseIntは応急処置
	var xOffset = parseInt(jQuery("#imgArea").position().left);
	var yOffset = parseInt(jQuery("#imgArea").position().top);

	//alert('(' + offset[0] + ', ' + offset[1] + ') -> (' + xOffset + ', ' + yOffset + ')' + y + ',' + x);
	
	var xPos = parseInt(x * parseFloat(jQuery("#dispWidth").val())  / parseFloat(jQuery("#orgWidth").val())  + 0.5);
	var yPos = parseInt(y * parseFloat(jQuery("#dispHeight").val()) / parseFloat(jQuery("#orgHeight").val()) + 0.5);
	
	 plotDots(id, xPos+xOffset, yPos+yOffset, set);
	 
}


function DeleteLocationRows()
{
	var checkObj = document.form1.elements['rowCheckList[]'];
	if(checkObj == null)		return;	

	//----------------------------------------------------------------------------------------------
	// チェックボックスが最低1個でも選択されていることを確認する
	//----------------------------------------------------------------------------------------------
	var flg = false;
	var checkCnt = 0;
	var checkedId = new Array();

	if(checkObj.length == null)
	{
		if(checkObj.checked)
		{
			 flg = true;
			 checkedId[checkCnt] = checkObj.value;
			 checkCnt++;
		}
	}
	else
	{
		for(var i=0; i<checkObj.length; i++)
		{
			if(checkObj[i].checked)
			{
				flg = true;
			 checkedId[checkCnt] = checkObj[i].value;
			 checkCnt++;
			}
		}
	}
	//----------------------------------------------------------------------------------------------

	if(!flg)
	{
	   alert('Please select at least one location!');
	}
	else
	{
		var str = 'Do you delete selected location';
		if(checkCnt > 1)  str += 's?';
		else		 	  str += '?';
	
		if(confirm(str))
		{
			var tableObj = document.getElementById("posTable");
			var rowNum   = tableObj.rows["length"];	
			var imgNum   = jQuery('#imgNum').val();
			var mode     = jQuery("#feedbackMode").val();

			for(var j=0; j<checkCnt; j++)
			{
				Element.remove('row' + checkedId[j]);
			}
			jQuery('#interruptFNFlg').val(1);

			if(jQuery('#checkVisibleFN').attr('checked') == false)
			{
				jQuery('#checkVisibleFN').attr('checked', true);
				jQuery('#visibleFlg').val(1);
			}
			JumpImgNumber(imgNum);
		}
		else
		{
			for(var i=0; i<checkObj.length; i++)
			{
				checkObj[i].checked = false;
			}
		}
	}
}



function IntegrateLocationRows()
{
	var checkObj = document.form1.elements['rowCheckList[]'];
	if(checkObj == null)		return;	



	//----------------------------------------------------------------------------------------------
	// チェックボックスにチェックが入っている個数をカウント
	//----------------------------------------------------------------------------------------------
	var checkCnt = 0;
	var checkedId = new Array();

	if(checkObj.length == null)
	{
		if(checkObj.checked)
		{
			 checkedId[checkCnt] = checkObj.value;
			 checkCnt++;
		}
	}
	else
	{
		for(var i=0; i<checkObj.length; i++)
		{
			if(checkObj[i].checked)
			{
				 checkedId[checkCnt] = checkObj[i].value;
				 checkCnt++;
			}
		}
	}
	//----------------------------------------------------------------------------------------------
	
	if(checkCnt < 2)
	{
	   alert('Please select at least two locations!');
	}
	else
	{
		var str = 'Do you integrate selected locations?';
		
		if(confirm(str))
		{
			var registTime = jQuery("#registTime").val();

			if(registTime == "")
			{
				jQuery("#interruptFNFlg").val(1);
			}

			var tObj = document.getElementById("posTable")
		
			var xTmp = 0;
			var yTmp = 0;
			var zTmp = 0;
			var idStr = "";
			
			var orgWidth   = jQuery("#orgWidth").val();
			var orgHeight  = jQuery("#orgHeight").val();
			var dispWidth  = jQuery("#dispWidth").val();
			var dispHeight = jQuery("#dispHeight").val();

			for(var j=0; j<checkCnt; j++)
			{
				// ↓Consensusモードで新たに追加した行を含む統合は行わない
				if(tObj.rows[checkedId[j]].cells[7].innerHTML == "")
				{
					alert('Error: The integration including the row that you newly added in consensual mode is impossible.');
					JumpImgNumber(jQuery("#imgNum").val());
					return false;
				}
				else
				{
					xTmp += parseInt(tObj.rows[checkedId[j]].cells[2].innerHTML);
					yTmp += parseInt(tObj.rows[checkedId[j]].cells[3].innerHTML);
					zTmp += parseInt(tObj.rows[checkedId[j]].cells[4].innerHTML);
					if(j>=1)  idStr += ',';
					idStr += tObj.rows[checkedId[j]].cells[7].innerHTML;
				}
			}

			var xPos = parseInt(parseFloat(xTmp) / parseFloat(checkCnt) + 0.5);
			var yPos = parseInt(parseFloat(yTmp) / parseFloat(checkCnt) + 0.5);
			var zPos = parseInt(parseFloat(zTmp) / parseFloat(checkCnt) + 0.5);

			for(var j=0; j<checkCnt; j++)
			{
				Element.remove('row' + checkedId[j]);
			}

			//alert(xPos + ', ' + yPos + ', ' + zPos + ', ' + idStr);			
			
			// parseIntは応急処置
			var xOffset = parseInt(jQuery("#imgArea").position().left);
			var yOffset = parseInt(jQuery("#imgArea").position().top);
        
			var xPos2 = parseInt(xPos * parseFloat(dispWidth) / parseFloat(orgWidth)   + 0.5);
			var yPos2 = parseInt(yPos * parseFloat(dispHeight) / parseFloat(orgHeight) + 0.5);

			var rowNum   = tObj.rows["length"];	
	
			plotDots(rowNum, xPos2+xOffset, yPos2+yOffset, 0);

			var candStr = jQuery("#candStr").val();
			var mode    = jQuery("#feedbackMode").val();
    
			var insObj=tObj.insertRow(rowNum);
			insObj.id = "row" + rowNum;
			insObj.onclick = "ClickPositionTable('" + insObj.id + "'," + zPos + ");";

			var colCheck        = insObj.insertCell(0);
			var colId           = insObj.insertCell(1);
			var colX            = insObj.insertCell(2);
			var colY            = insObj.insertCell(3);
			var colZ            = insObj.insertCell(4);
			var colNearest      = insObj.insertCell(5);
			var colEnteredBy    = insObj.insertCell(6);
			var colIntegratedId = insObj.insertCell(7);
	
			// 挿入行の文字色を決定(consensual feedback)
			if(mode == "consensualFeedback")
			{
				insObj.style.color ='#ff00ff';
				insObj.style.borderColor = '#c0c0c0';
			}

			colCheck.align="center";
			colCheck.innerHTML = '<input type="checkbox" name="rowCheckList[]" value="' + rowNum + '">';
	
    		colId.align = "right";
			colX.align = colY.align = colZ.align = colId.align;
			colNearest.align = colEnteredBy.align = "center";	
	
			colId.innerHTML = rowNum;
			colX.innerHTML  = xPos;
			colY.innerHTML  = yPos;
			colZ.innerHTML  = zPos;
	
			colNearest.style.color ='#ffffff';
			colNearest.innerHTML += 'check';

			colEnteredBy.innerHTML = jQuery("#userID").val();
		
			colIntegratedId.innerHTML = idStr;
			insObj.style.display ='none';
			
			if(jQuery("#checkVisibleFN").attr('checkVisibleFN') == false)
			{
				jQuery("#checkVisibleFN").attr('checked') = true;
				jQuery("#visibleFlg").val(1);
			}
			JumpImgNumber(zPos);
		}

	}
}


function CheckNearestHiddenTP(rowNum)
{

	var tObj=document.getElementById("posTable");
	
	var posX = tObj.rows[rowNum].cells[2].innerHTML;
	var posY = tObj.rows[rowNum].cells[3].innerHTML;
	var posZ = tObj.rows[rowNum].cells[4].innerHTML;

	var distTh = jQuery("#distTh").val();
	distTh = distTh * distTh;

	var candPos = jQuery("#candStr").val().split('^');
	var candNum = candPos.length/4;
	
	var distMin = 10000;
	var minId = 0;
	var ret = "";
		
	for(var i=0; i<candNum; i++)
	{
		var candX = candPos[ i * 4 + 1 ];
		var candY = candPos[ i * 4 + 2 ];
		var candZ = candPos[ i * 4 + 3 ];
				
		var dist = (candX-posX)*(candX-posX)+(candY-posY)*(candY-posY)+(candZ-posZ)*(candZ-posZ);
		
		if(dist < distMin)
		{
			distMin = dist;
			minId = i * 4;
		}
	}

	if(distMin < distTh)  ret = candPos[minId] + ' / ' + Math.sqrt(distMin).toFixed(2);
	else  				  ret = '- / -';

	return ret;
}


function ConfirmFNLocation()
{
	if(confirm('Do you define all FN(s)?'))
	{
		jQuery("#registFNFlg").val(1);
		jQuery("#interruptFNFlg").val(0);
		
		JumpImgNumber(jQuery("#imgNum").val());
	}
}

function ChangeVisibleFN()
{
	jQuery("#visibleFlg").val(jQuery("#checkVisibleFN").is(':checked') ? 1 : 0);

	JumpImgNumber(jQuery("#imgNum").val());
}

function ChangePresetMenu(imgNum)
{
	var tmpStr = jQuery("#presetMenu option:selected").val().split("^");
	
	jQuery("#presetName").val(selectedPreset.text());
	jQuery("#windowLevel").val(tmpStr[0]);
	jQuery("#windowWidth").val(tmpStr[1]);
	
	JumpImgNumber(imgNum);
}

jQuery(document).ready(function(){
	
	jQuery("img#imgArea.enter").click(function(e){

		var tObj    = document.getElementById("posTable");
		var candStr = jQuery("#candStr").val();
		var mode    = jQuery("#feedbackMode").val();
		var imgNum  = jQuery("#imgNum").val();

		// Number of rows
    	var rowNum=tObj.rows["length"];

		plotDots(rowNum, e.pageX, e.pageY, 0);

		var x = e.pageX - jQuery("img#imgArea").position().left;
		var y = e.pageY - jQuery("img#imgArea").position().top;

		var xPos = parseInt(x*parseFloat(jQuery("#orgWidth").val())/parseFloat(jQuery("#dispWidth").val())+0.5);
		var yPos = parseInt(y*parseFloat(jQuery("#orgHeight").val())/parseFloat(jQuery("#dispHeight").val())+0.5);
	
		var insObj=tObj.insertRow(rowNum);
		insObj.id = "row" + rowNum;
		insObj.onclick = "ClickPositionTable('" + insObj.id + "'," + imgNum + ");";

		var colCheck   = insObj.insertCell(0);
		var colId      = insObj.insertCell(1);
		var colX       = insObj.insertCell(2);
		var colY       = insObj.insertCell(3);
		var colZ       = insObj.insertCell(4);
		var colNearest = insObj.insertCell(5);
	
		// 挿入行の文字色を決定(consensual feedback)
		if(mode == "consensualFeedback")
		{
			insObj.style.color ='#ff0000';
			insObj.style.borderColor = '#c0c0c0';
		}

		colCheck.align="center";
		colCheck.innerHTML = '<input type="checkbox" name="rowCheckList[]" value="' + rowNum + '">';
	
    	colId.align = "right";
		colX.align = colY.align = colZ.align = colId.align;
		colNearest.align = "center";	
	
		colId.innerHTML = rowNum;
		colX.innerHTML  = xPos;
		colY.innerHTML  = yPos;
		colZ.innerHTML  = imgNum;
	
		colNearest.style.color ='#ffffff';
		colNearest.innerHTML = 'check';

		if(mode == "consensualFeedback")
		{
			var colEnteredBy =insObj.insertCell(6);
		    colEnteredBy.align="center";
			colEnteredBy.innerHTML = jQuery("#userID").val();
		
			var colIntegratedId = insObj.insertCell(7);
			colIntegratedId.style.display ='none';
		}
	
		if(rowNum == 1)
		{
			jQuery("#blockDeleteButton").html('<input type="button" id="delButton" value="delete" onclick="DeleteLocationRows();">');

			if(mode == "consensualFeedback")
			{
				jQuery("#blockDeleteButton").append('&nbsp;&nbsp;<input type="button" id="integrationButton" value="integration">');
			}
		}	
	
		if(jQuery("#checkVisibleFN").attr('checkVisibleFN') == false)
		{
			jQuery("#checkVisibleFN").attr('checked') = true;
			jQuery("#visibleFlg").val(1);
		}
		JumpImgNumber(imgNum);
	});
});





